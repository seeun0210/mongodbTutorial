# Atomicity

MongoDB에서 원자성(Atomicity)은 데이터베이스 작업이 "원자적"으로 실행된다는 것을 의미합니다. "원자적"이라는 것은 작업이 완전히 성공하거나 완전히 실패하는 성질을 말합니다. 따라서 작업 중간에 오류가 발생해도 데이터의 무결성이 유지됩니다.

## 원자성의 중요성

원자성은 데이터베이스의 ACID 특성 중 하나로, 데이터 무결성을 유지하고 복잡한 데이터베이스 작업이 중단되거나 실패했을 때 발생할 수 있는 데이터 손실이나 비일관성을 방지합니다. 이는 데이터베이스의 안정성과 신뢰성을 높이는 데 중요한 역할을 합니다.

## MongoDB의 원자성 지원

MongoDB는 여러 수준에서 원자성을 지원합니다. 각 수준에서 원자성이 어떻게 동작하는지 살펴보겠습니다.

### 단일 문서 원자성

- **단일 문서 작업**: MongoDB는 단일 문서에 대한 쓰기 작업(예: `insertOne`, `updateOne`, `deleteOne`)이 원자적으로 실행되도록 보장합니다. 단일 문서에 대한 작업은 전적으로 성공하거나 실패하며, 중간 상태로 남지 않습니다.
- **임베디드 문서(Embedded Documents)**: 임베디드 문서나 배열을 포함한 단일 문서의 쓰기 작업은 원자적으로 처리됩니다. 이 기능은 복잡한 데이터 구조에서도 원자성을 유지하는 데 도움이 됩니다.

### 트랜잭션을 통한 원자성

- **다중 문서 트랜잭션**: MongoDB는 다중 문서 트랜잭션을 지원합니다. 이는 여러 문서에 대한 작업을 원자적으로 처리할 수 있게 합니다. 트랜잭션 내의 모든 작업이 성공적으로 완료되어야 트랜잭션이 성공합니다. 그렇지 않으면 트랜잭션이 롤백되고, 모든 변경 사항이 취소됩니다.
- **트랜잭션 사용**: 다중 문서 작업이 원자적으로 실행되도록 하기 위해 트랜잭션을 사용할 수 있습니다. 트랜잭션을 사용하면 데이터 무결성과 일관성을 유지할 수 있습니다.

### 예시: 단일 문서 원자성

```javascript
// 단일 문서에 대한 업데이트 작업
db.collection('users').updateOne(
  { _id: userId },
  { $set: { name: 'John Doe' } }
);
// 이 작업은 원자적으로 실행되며, 중간에 오류가 발생하면 작업이 실패로 간주됩니다.
```

### 예시: 다중 문서 트랜잭션

```javascript
// 트랜잭션을 사용하여 여러 문서를 원자적으로 업데이트
const session = client.startSession();

session.withTransaction(() => {
  db.collection('users').insertOne({ name: 'Alice' }, { session });
  db.collection('orders').insertOne({ product: 'Book', quantity: 2 }, { session });
});

// 트랜잭션이 성공적으로 완료되면 모든 작업이 적용되고, 오류가 발생하면 롤백됩니다.
```

이 예시에서는 트랜잭션을 사용하여 여러 문서를 원자적으로 처리합니다. 트랜잭션 내의 모든 작업이 성공적으로 완료되어야 트랜잭션이 성공하며, 그렇지 않으면 트랜잭션이 롤백됩니다.

## 원자성의 한계

- **단일 컬렉션 원자성**: 단일 문서의 작업은 원자적이지만, 단일 컬렉션의 작업은 트랜잭션을 사용하지 않는 한 원자적이지 않을 수 있습니다.
- **다중 문서 원자성**: 다중 문서 작업은 트랜잭션을 통해 원자성을 보장할 수 있지만, 이 경우 성능에 영향을 줄 수 있습니다.

원자성은 데이터베이스의 무결성과 안정성을 유지하는 데 필수적인 개념입니다. MongoDB는 단일 문서 작업의 원자성을 기본적으로 제공하며, 다중 문서 작업의 원자성을 위해 트랜잭션을 지원합니다. 이를 통해 데이터베이스의 일관성을 유지하고, 작업 중 오류로 인한 데이터 손실을 방지할 수 있습니다.
